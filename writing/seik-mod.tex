\documentclass{report}
\usepackage{mathpartir,amsmath,amssymb,xspace}
\newcommand{\intt}{\texttt{int}}
\newcommand{\strt}{\texttt{str}}
\newcommand{\anyt}{\texttt{any}}
\newcommand{\ifthenelse}[3]{\texttt{if0 }#1\texttt{ then }#2\texttt{ else }#3}
\newcommand{\cast}[1]{\langle #1\rangle}
\newcommand{\xt}[1]{\texttt{#1}}
\newcommand{\castreduce}{\longrightarrow_{cr}}
\newcommand{\expreduce}{\longrightarrow_{e}}
\newcommand{\stepsto}{\longrightarrow}
\newcommand{\intv}[1]{\xt{int}[#1]}
\newcommand{\strv}[1]{\xt{str}[#1]}
\newcommand{\cstctx}{\nu}
\newcommand{\tlate}{\rightsquigarrow}
\begin{document}

\newcommand{\B}{\ensuremath{~|~}\xspace}
\newcommand{\new}{\ensuremath{\texttt{new}}\xspace}
\newcommand{\NEW}[2]{\ensuremath{  \new ~ #1 ( #2 )}\xspace}
\renewcommand{\bar}[1]{\ensuremath{\overline{ #1} }\xspace}

\newcommand{\m}{\ensuremath{\xt{m}}\xspace}
\newcommand{\f}{\ensuremath{\xt{f}}\xspace}
\newcommand{\C}{\ensuremath{\xt{C}}\xspace}

%% TOODO if0 => if   ??


%% Cast syntax??

%% TODO \bar p ==> \bar x



Syntax:
\begin{align*}
\tau &::= \anyt \B  \strt \B  \intt \B  \{\bar{\xt{f}:\tau},\bar{\xt{m}(\bar{\tau}):\tau}\}\\
e &::= k \B  e.\m(\bar{e}) \B  \ifthenelse{e}{e}{e}\B e + e\\
&\B x\B \NEW \C {\bar{e}} \B  e\cast{\tau}\\
v &::= k \B  \{\bar{\texttt{f}=v},\bar{\xt{m}(\bar{\xt{p}})=e}\} \B  v\cast{I!}\\
I &::= \strt \B  \intt \B  \{\bar{\xt{f}:I},\bar{\xt{m}(\bar{I}):I}\}\\
c &::= \iota \B  I? \B  I! \B  \{\bar{\xt{f}\cast{c}}, \bar{\xt{m}(\bar{c}):c}\}\\
cv &::= v \B  v\cast{c} \B  \{\bar{\f=cv},\bar{\m(\bar{\xt{p}})=e}\}\\
\mu &::= \emptyset \B  \mu( a \mapsto v )\\
F &::=    \square.\m(\bar e) 
   \B     v.\m(\bar v,\square,e, \bar e) 
   \B     v!\m(\bar{v},\square,e,\bar{e}) 
   \B     \ifthenelse{\square}{e}{e} 
   \B     \square + e 
   \B      v + \square\\
&\B \NEW  \C {\bar{v},\square,\bar{e}}\\
\mathit{CF} &::= \{\texttt{x}=v\ldots,\texttt{y}=\square,\texttt{z}=e,\ldots,\texttt{f(a:}\tau\texttt{):}\tau'=e,\ldots\}\\
\end{align*}

\begin{mathpar}
\inferrule*[right=SubRefl]{ }{ C <: C }

\inferrule*[right=SubClass]{\texttt{class }C\texttt{ extends }D}{ C <: D }

\inferrule*[right=SubInt]{ }{ \intt <: \intt }

\inferrule*[right=SubStr]{ }{ \strt <: \strt }
\end{mathpar}

\begin{mathpar}
\inferrule*[right=TVar]{\Gamma(x) = A }{\Gamma \vdash x : A}

\inferrule*[right=TStr]{ }{\Gamma \vdash string : \strt}

\inferrule*[right=TInt]{ }{\Gamma \vdash int : \intt}

\inferrule*[right=TSub]{\Gamma \vdash e : \tau' \\ \tau' <: \tau}{\Gamma \vdash e : \tau}

\inferrule*[right=TApp]{\bar{\Gamma \vdash e_i : \tau_i \vee \Gamma \vdash e_i : \anyt} \\ \Gamma \vdash e : \{\ldots, l(\bar{\tau'_i}):\tau', \ldots\}}{\Gamma \vdash e.l(\bar{e_i}) : \tau'}

\inferrule*[right=TIf]{ 
\Gamma \vdash e_1 : \intt \vee \Gamma \vdash e_1 :\anyt \\ \Gamma \vdash \tau \\ \Gamma \vdash e_2 : \tau \\ \Gamma \vdash e_3 : \tau} { \Gamma \vdash \ifthenelse{e_1}{e_2}{e_3} : \tau}

\inferrule*[right=TPlus]{ \Gamma \vdash e_1 : \intt \\ \Gamma \vdash e_2 : \intt} { \Gamma \vdash e_1 + e_2 : \intt}

\inferrule*[right=TField]{ \Gamma \vdash e : \{\ldots l:\tau \ldots\}} { \Gamma \vdash e.l : \tau}

\inferrule*[right=TNew]{\bar{\Gamma \vdash e : \tau \vee \Gamma \vdash e : \anyt} \\ \Gamma(C) = \{\ldots, \bar{\xt{f} : \tau'}, \ldots\}}{\Gamma \vdash \texttt{new }C(\bar{e}) : C}

\inferrule*[right=TCast]{\Gamma \vdash e : \tau' \\ \tau <: \tau' \vee \tau' = \anyt}{\Gamma \vdash e\cast{\tau}}

\inferrule*[right=TClass]{ 
\bar{\Gamma \vdash D} \\  
\bar{\xt{m}'(\bar{\xt{p}:\tau_D''}):\tau_D' \in D \implies \xt{m}'(\bar{\xt{p}:\tau_C''}):\tau_C' \in C \wedge (\tau_C' <: \tau_D' \vee \tau_D' = \anyt) \wedge (\bar{\tau_D'' <: \tau_C'' \vee \tau_C'' = \anyt})}\\
\bar{\xt{f}:\tau_D \in D \implies \xt{f}:\tau_C \in C \wedge (\tau_C <: \tau_D \vee \tau_D = \anyt)}\\
\bar{\Gamma,\xt{this}:C,\bar{\xt{f}:\tau},\bar{\xt{p}:\tau''} \vdash e : \tau'}\\s
}{\Gamma \vdash \texttt{class } C \texttt{ implements } \bar{D}\;\{\bar{\xt{f} : \tau}, \bar{\xt{m}(\bar{\xt{p}:\tau''}):\tau' = \{ e \}}\}}
\end{mathpar}

\subsection{Cast Insertion}

\begin{mathpar}
\inferrule*[]{\Gamma \vdash e \tlate e' : \tau' \\ \tau' \sim \tau}{\Gamma \vdash e\cast{\tau} \tlate e'\cast{\tau' \Rightarrow \tau} : \tau}

\inferrule*[]{\Gamma \vdash e \tlate e' : \{\ldots, l(\bar{\tau}):\tau', \ldots\} \\ \bar{\Gamma \vdash e_a \tlate e_a' : \tau_a} \\ \bar{\tau \sim \tau_a} \\ \bar{(\tau_a \Rightarrow{\tau}) = c}}{\Gamma \vdash e.l(\bar{e_a}) \tlate e.l(\bar{e_a'\cast{c}}) : \tau'}

\inferrule*[]{ \Gamma \vdash e \tlate e' : \anyt \\  \bar{\Gamma \vdash e_a \tlate e_a' : \tau_a} \\ \anyt \Rightarrow \{l(\bar{\tau_a}):\anyt\} = c}{\Gamma \vdash e.l(\bar{e_a}) \tlate e'\cast{c}.l(\bar{e_a'}) : \anyt }

\inferrule*[]{\Gamma \vdash e_1 \tlate e_1' : \tau_1 \\ \tau_1 \sim \intt \\ \Gamma \vdash e_2\tlate e_2':\tau_2 \\ \Gamma \vdash e_3 \tlate e_3' : \tau_2}{\Gamma \vdash \ifthenelse{e_1}{e_2}{e_3} \tlate \ifthenelse{e_1'\cast{\tau_1 \Rightarrow \intt}}{e_2'}{e_3'} : \tau_2} 

\inferrule*[]{\Gamma \vdash e_1 \tlate e_1' : \tau_1 \\ \Gamma \vdash e_2 \tlate e_2' : \tau_2 \\ \tau_1 \sim \intt \\ \tau_2 \sim \intt }{\Gamma \vdash e_1 + e_2 \tlate e_1'\cast{\tau_1 \Rightarrow \intt} + e_2' \cast{\tau_2 \Rightarrow \intt}:\intt }

\inferrule*[]{x:\tau \in \Gamma}{\Gamma \vdash x \tlate x : \tau}

\inferrule*[]{C=\{\bar{\xt{f}:\tau},\ldots\} \in \Gamma \\ \bar{\Gamma \vdash e \tlate e' : \tau'} \\ \bar{\tau \sim \tau'}}{\Gamma \vdash \xt{new } C(\bar{e}) \tlate \xt{new }C(\bar{e'\cast{\tau' \Rightarrow \tau}}) : C}
\end{mathpar}


\section{Dynamic semantics:}

Expression reduction:

\begin{mathpar}
\inferrule*[]{ e,v \expreduce e',v'}{F[e],v \expreduce F[e'],v'}

\inferrule*[]{\xt{class}\;C\{\bar{\xt{f}:\tau}, \bar{\xt{m}(\bar{\xt{p}:\tau}):\tau' = e}\}\\\mu'=\mu(a\mapsto\{\bar{f=v},\bar{\xt{m}(\bar{\xt{p}:\tau}):\tau' = e}\}) }{ \xt{new }C(\bar{v}),\mu \expreduce a,\mu'}

\inferrule*[]{ \mu[a\mapsto \{\ldots,\xt{m}(\bar{\xt{p}\cast{c}})=e\}] }{ a.\xt{m}(\bar{v}),\mu \expreduce a!\xt{m}(\bar{v\cast{c}})}

\inferrule*[]{a\mapsto \{\ldots,\xt{m}(\bar{\xt{p}\cast{c}})=e\}]}{a!\xt{m}(\bar{v}) \expreduce [a/\xt{this}][\bar{v/\xt{p}}]e,\mu}

\inferrule*[]{ \mu[a\mapsto\{\ldots,\xt{f}=v,\ldots\}] }{a.f,\mu \expreduce v,\mu}

\inferrule*[]{ \mu' = \mu[a\mapsto \{\ldots,\xt{f}=v,\ldots\}] }{a.f = v,\mu \expreduce v,\mu'}

\inferrule*[]{ }{ \ifthenelse{\intv{0}}{e_1}{e_2},\mu \expreduce e_1,\mu }

\inferrule*[]{n\neq 0}{ \ifthenelse{\intv{n}}{e_1}{e_2},\mu \expreduce e_1,\mu }

\inferrule*[]{ n_1 + n_2 = n_3 }{ \intv{n_1} + \intv{n_2},\mu \expreduce \intv{n_3},\mu}
\end{mathpar}

Cast reduction:
\begin{mathpar}
\inferrule*[]{ e,v \castreduce e',v'}{F[e],v \castreduce F[e'],v'}

\inferrule*[]{ e,v\castreduce e',v' }{ CF[e],v \longrightarrow CF[e'],v'}

\inferrule*[]{ }{ v\cast{\iota} \castreduce v}

\inferrule*[]{ I_1 \sim I_2 }{ v\cast{I_1!}\cast{I_2?} \castreduce v\cast{I_1 \Rightarrow I_2}}

\inferrule*[]{
\cstctx(a) = v : \tau \\ 
\tau \sqcap \tau' = \tau''\\
\tau'' \neq \tau\\
}{ a\cast{\tau'},\cstctx \castreduce a,\cstctx(a\mapsto v \cast{\tau \Rightarrow \tau''})}

\inferrule*[]{
\mu(a) = v : \tau \\ \tau \sqcap \tau'
 = \tau}{ a\cast{\tau'},\cstctx \castreduce a,\cstctx}

\inferrule*[]{
	v = \{\bar{\xt{f} = v'}, \bar{\xt{m}(\bar{\xt{p}}) = e}\}\\
	c = \{\bar{\xt{f}:c_f},\bar{\xt{m}(\bar{c_p}):c_m}\}
}{
	v\cast{c},\cstctx \castreduce \{\bar{\xt{f} = v\cast{c_f}}, \bar{
\xt{m}(\bar{\xt{ip}}) = \texttt{this}.\xt{m'}(\bar{\xt{ip}\cast{c_p}}),
\xt{m'}(\bar{\xt{p}}) = e\cast{c_m}
}\}
}
\end{mathpar}

State reduction:
\begin{mathpar}
\inferrule*[]{ e,v\castreduce e',v' }{ e,v \longrightarrow e',v'}

\inferrule*[]{ e,v\expreduce e',v' }{ e,v \longrightarrow e',v'}

 \inferrule*[]{
 	\cstctx(a) = cv : \tau\\
 	cv,\cstctx \castreduce cv',\cstctx'\\
 	\cstctx'(a)_{rtti} = \tau\\
 }{
 	e,\cstctx \longrightarrow e,\cstctx'(a \mapsto cv' : \tau)
 }

 \inferrule*[]{
 	\cstctx(a) = cv : \tau\\
 	cv,\cstctx \castreduce cv',\cstctx'\\
 	\cstctx'(a)_{rtti} \neq \tau\\
 }{
 	e,\cstctx \longrightarrow e,\cstctx'
 }
\end{mathpar}

Cast to coersion compilation
\begin{mathpar}
\inferrule*[]{}{\intt \Rightarrow \intt = \iota}

\inferrule*[]{}{\strt \Rightarrow \strt = \iota}

\inferrule*[]{}{I \Rightarrow \anyt = I!}

\inferrule*[]{}{\anyt \Rightarrow I = I?}

\inferrule*[]{}{\{\bar{\xt{f}:\tau_1}, \bar{\xt{m}(\bar{\xt{p}:\tau_1''}):\tau_1'} \} \Rightarrow \{\bar{\xt{f}:\tau_2}, \bar{\xt{m}(\bar{\xt{p}:\tau_2''}):\tau_2'} \} = \{\bar{\xt{f}:\tau_1\Rightarrow\tau_2}, \bar{\xt{m}(\bar{\xt{p}:\tau_2'' \Rightarrow \tau_1''}) : \tau_1' \Rightarrow \tau_2'}\}}
\end{mathpar}

Meet
\begin{mathpar}
\inferrule*[]{}{\tau \sqcap \tau = \tau}

\inferrule*[]{}{\tau \sqcap \anyt = \tau}

\inferrule*[]{}{\anyt \sqcap \tau = \tau}

\inferrule*[]{}{\{\bar{\xt{f}:\tau_1}, \bar{\xt{m}(\bar{\xt{p}:\tau_1''}):\tau_1'} \}\sqcap \{\bar{\xt{f}:\tau_2}, \bar{\xt{m}(\bar{\xt{p}:\tau_2''}):\tau_2'} \} = \{\bar{\xt{f}:\tau_2 \sqcap \tau_2}, \bar{\xt{m}(\bar{\xt{p}:\tau_1'' \sqcap \tau_2''}):\tau_1' \sqcap \tau_2'} \}}
\end{mathpar}
\end{document}
