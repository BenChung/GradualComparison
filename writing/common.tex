%!TEX output_directory=pdfs
\documentclass{report}
\usepackage{xspace,listings,url,subfigure,framed,amssymb,
            amsmath,mathpartir,hyperref,
            stmaryrd, graphicx, fullpage % double brackets llbracket
}
\input{macros}
\begin{document}

\section*{The One}

\center\begin{minipage}{4cm}\begin{tabular}{l@{~~~}l}
\e &::=  \x \\
   \Alt{ \Get\e\f }
   \Alt{ \Set\e\f\e }
   \Alt{ \Call\e\m{\b\e} }
   \Alt{ \New\C{\b\e} }
   \Alt{ \Cast\t\e }
   \Alt{ \a{} }
\fd &::= 
    \Ftype\f\t   \\
\end{tabular}\end{minipage}\begin{minipage}{4cm}\begin{tabular}{l@{~~~}l}
\md &::=
    \Mdef\m\x\t\t\e \\
\c &::= \Class \C {\b{\fd}}{\b{\md} } \\
\mt &::= \Mtype\m{\b\t}\t\\
\E &::= \x : \t \\
  \Alt{$\cdot$}
\t &::= ~ \any \\
   \Alt{ \Type{  \b{ \mt } } }
\ts&::= \xtns{b}\B\xtns{m}\B\xtns{c} %TODO fix spacing
\end{tabular}\end{minipage}


\hrulefill

\begin{minipage}{8cm}
\opdef{\Reduce{\cb_1}{\ep 1}{\sp 1}{\cb_2}{\ep 2}{\sp 2}}{\ep1 \sp1 evaluates to \ep2 \sp2 or \err in a step}\\[-1mm]
\begin{tabular}{@{}l@{}l@{~}l@{~}l}
\CondRule{E1}{ %% e -> e'
  \Reduce {\cb_1}{\ep 1}{\sp 1}{\cb_2}{\ep 2}{\sp 2}
}{
  \ReduceA {\cb_1}{\Ctx{\ep1}}{\sp 1}{\cb_2}{\Ctx{\ep2}}{\sp 2}
}
\CondRule{E2}{ %% new C -> a
   \alloc{\sp2}{\ap1}{\sp1}{\Obj{\b\a}\C}
}{ 
    \ReduceA{\b{\C_1}}{ \New{\C_2}{\b\a} }{\sp1}{\b{\C_1}}{\ap1}{\sp 2}
}
\CondRule{E3}{ %% a.m -> e
   \dispatch{\b\x}\e\s\a\m
}{
   \ReduceA{\cb}{\s}{\Call\a\m{\b{\ap 1}}}{\cb}{[\a/\this~\b{{\ap 1}/\x}]\e}\s
}
\CondRule{E3}{ 
     \readfield{\ap1}\s\a\f
}{
  \ReduceA{\cb}{\Get\a\f}{\s}{\cb}{\ap 1}{\s}
}
\CondRule{E4}{
     \setfield{\sp2}{\sp1}\a\f{\ap1}
}{
     \ReduceA{\cb}{\Set\a\f{\ap 1}}{\sp 1}{\cb}{\ap 1}{\sp 2}
}
\CondRule{E5}{
  \cast{\ap1}{\t}{\sp1}{\cbp1}{b} = \e, \sp2, \cbp2
}{ 
    \ReduceA{\cb_1}{\Cast{\tp 1}{\ap1}}{\sp1}{\cb_2}{\e}{\sp2}
}
\CondRule{E5}{
  \cast{\ap1}{\t}{\sp1}{\cbp1}{m} = \e, \sp2, \cbp2
}{ 
    \ReduceA{\cb_1}{\mCast{\tp 1}{\ap1}}{\sp1}{\cb_2}{\e}{\sp2}
}
\CondRule{E5}{
  \cast{\ap1}{\t}{\sp1}{\cbp1}{c} = \e, \sp2, \cbp2
}{ 
    \ReduceA{\cb_1}{\cCast{\tp 1}{\ap1}}{\sp1}{\cb_1}{\ap1}{\sp1}
}
\CondRule{E6}{
  \cast{\a}{\t}{\sp1}{\cb}{\_} = \err
}{ 
    \ReduceA{\cb}{\Cast{\tp 1}\a}\s\err{}{}
}
\CondRule{E7}{
    \Reduce{\cb}\e{\sp 1}\err{}{}
}{
    \ReduceA{\cb}{\Ctx\e}{\sp1}\err{}{}
}
\end{tabular}\end{minipage}
%%%%%%%%%%%%%%%%%%% CONTEXTS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\\[3mm]
\begin{minipage}{4cm}\begin{tabular}{l@{~~}l@{~}l}
\s &::= ~~\none & \B ~~
  \Heap\s{\Bind\a{\Obj{\b\a}{\t}}} \\[2mm]
\xt{E} &::=    \Get\square\f &\B~
       \Set\square\f\e   ~\B~
       \Set\a\f\square   ~\B~  
       \Call\square\m\e  ~\B~
      \Call\a\m{\b\a\,\square\,\b\e} \\
 &\B~     \Cast\t\square  &\B~
      \New\C{\b \a\,\square\,\b\e}
\end{tabular}
\end{minipage}

\hrulefill

\input{figures/subtyping}

\hrulefill

\input{figures/basetype}

\hrulefill

%\input{figures/trtrans}

%\hrulefill

\input{figures/monomeet}

\hrulefill

\begin{mathpar}
\IRule{Refine-Field}{
  \b{\meet{\t}{\t'} = \t''}
}{
  \spec{\f:\t,\t'} = (\f():\t''=\this.\xt{f}),\\
  (\f_\xt{u}():\any=\Cast{\any}{\this.\xt{f})},\\
  (\f\xt{!}(\x : \t''):\t''=\this.\xt{f}=\x), \\
  (\f\xt{!}_\xt{u}(\x : \any):\any=\Cast{\any}{\this.\xt{f}=\Cast{\any}{\x}})
}

\IRule{Refine-Method}{
  \b{\meet{\tp1}{\tp1'} = \tp1''}\\
  {\meet{\tp2}{\tp2'} = \tp2''}
}{
  \spec{\m(\b{\x:\tp1}):\tp2 = \e,\m(\b{\tp1'}):\tp2'} = 
  (\m(\b{\x:\tp1''}):\tp2'' = \Cast{\tp2''}{\e}), \\
  (\m_\xt{u}(\b{\x:\any}):\any = \Cast{\any}{\this.{\m}(\Cast{\tp1''}{\x})})
}

\IRule{Refine-Class}{
  \b{\meet{\t}{\t'} = \t''}
}{
  \spec{\Class{\C}{\b{\f : \t}}{\b{\md}}, \xt{D}, \{\b{\f():\t'},\b{\mt}\}} = \Class{\D}{\b{\f : \t''}}{\b{\spec{\f:\t,\t'}},\b{\spec{\md,\mt}}}
}
\end{mathpar}

\hrulefill

\begin{mathpar}
\IRule{Cast-Wrap}{\xt{D}\;\text{\emph{free}} \\ \s[\a \mapsto \{ \a' \ldots \B \C \}] \\ \cbp2 = \cbp1;\wrapper{\C \Rightarrow \t,\xt{D}}}{\cast\a{\t}\s{\cbp1}{\xt{b}} = \New{\xt{D}}\a, \s, \cbp2}

\IRule{Cast-Mono1 (monotonic)}{
  \Heap{\sp1}{\Bind{\ap 1}{\Obj{\a'_1,\ldots}\C\}}} \\
  \C \not\equiv \meet{\tp1}{\C} \\
  \cb' = \cb;\spec{\Class{\C}{\b{\fd}}{\b{\md}}, \xt{D}, \meet{\tp1}{\C}} \\
  \sp2 = \Heap{\sp1}{\Bind{\ap 1}{\Obj{\a'_1,\ldots}{\xt{D}}}} \\
  \s'_1 = \castfn{\a_1'}{\t'_1}{\sp2}{\cb'} \\ \ldots \\ \s'_n = \castfn{\a_n'}{\t'_n}{\s'_{n-1}}{\cb'}\\
}{
  \cast{\ap1}{\tp1}{\sp1}\cb\m = \ap1, \s'_n, \cb'\\
}
% \Reduce{\Cast{\tp 1}{\ap1}}{\sp1}{\ap1}{\sp2}

\IRule{Cast-Mono2 (monotonic)}{
  \Heap{\s}{\Bind{\ap 1}{\Obj{\b\a}\C\}}} \\
  \C \equiv \meet{\tp1}{\C} \\
}{
  \cast{\ap1}{\tp1}{\s}\cb\m = \ap1,\s,\cb\\
}

\IRule{Cast-Check (concrete)}{\Heap\s{\Bind\a{\Obj{\a_1,\ldots}{\C}}} \\ \C <: \tp2 }{\cast\a{\tp2}\s\cb\c = \a, \s, \cb}

\IRule{Cast-Any (star)}{ }{\cast\a{\any}\s\cb{\_} = \a, \s, \cb}

\IRule{Cast-Error}{ }{\cast\a{\t}\s\cb{\_} = \err}
\end{mathpar}

\hrulefill

\begin{mathpar}
\IRule{Insert-Recv (eager cast)}{\GenCast{\E}{\ep1}{\ep3}{\tp1} \\ \m(\b{x : \tp2}):\tp3 \in \tp1 \\ \b{\AnaCast{\E}{\ep2}{\ep4}{\tp2}}}{\inv{\E}{\Call{\ep1}\m{\b{\ep2}}} = \Call{\ep3}{\m}{\b{\ep4}}, \tp3}

\IRule{Insert-Dyn}{\GenCast{\E}{\ep1}{\ep3}{\any} \\ \AnaCast{\E}{\ep2}{\ep4}{\any}}{\inv{\E}{\Call{\ep1}\m{\b{\ep2}}} = \Call{\Cast{(\Type{\Mtype{\m_\xt{u}}{\b\any}{\any}}}{\ep3})}{\m_\xt{u}}{\b{\ep4}}, \any}

\IRule{Insert-Check (lazy cast)}{\GenCast{\E}{\ep1}{\ep3}{\tp1} \\ \m(\b{x : \tp2}):\tp3 \in \tp1 \\ \b{\AnaCast{\E}{\ep2}{\ep4}{\tp2}}}{\inv{\E}{\Call{\ep1}\m{\b{\ep2}}} = \Cast{\tp1}{(\Call{(\Cast{\Type{\Mtype{\m_\xt{u}}{\b\any}{\any}}}{\ep3})}{\m_\xt{u}}{\b{\Cast{\any}{\ep4}}})}, \tp1}
\end{mathpar}

\section{Addendum}

\input{figures/syncast}

\hrulefill

\input{figures/anacast}

\hrulefill

\input{figures/classtrans}

\hrulefill

\input{figures/conssub}

\hrulefill

\begin{mathpar}
\IRule{No-Cons}{ \tp1 \Sub \tp2 }{\MetaSub{\tp1}{\tp2}}

\IRule{Has-Cons}{\stcons{\tp1}{\tp2}}{\MetaSub{\tp1}{\tp2}}
\end{mathpar}

\end{document}