\newcommand{\M}[1]{\ensuremath{#1}\xspace}
\newcommand{\xt}[1]{\sf{#1}}
\newcommand{\bt}[1]{\xt{\bf #1}}

\newcommand{\class}{\M{\bt{class}}}
\newcommand{\G}{\Gamma}
\renewcommand{\int}{\xt{int}}
\newcommand{\coerce}{\Rightarrow} %% arrow used in coercions
\newcommand{\any}{\M{\star}}
\newcommand{\this}{\M{\xt{this}}}
\newcommand{\ifthenelse}[3]{\M{\bt{if}\;#1\;#2\;#3}}
\newcommand{\cast}[1]{\M{\langle #1\rangle}}
\newcommand{\scast}[1]{\M{\{\!#1\!\}}}
\newcommand{\creduce}{\longrightarrow_{cr}}  %% reduction
\newcommand{\ereduce}{\longrightarrow_{e}}   %%  reduction
\newcommand{\stepsto}{\longrightarrow}        %% reduction
\newcommand{\intv}[1]{\xt{int}[#1]}
\newcommand{\strv}[1]{\xt{str}[#1]}
\newcommand{\tlate}{\rightsquigarrow}
\newcommand{\cicast}{\hookrightarrow}
\newcommand{\CICAST}[3]{\Gdash #1\cicast #3 \Leftarrow #2 }
\newcommand{\s}{\sigma}
\renewcommand{\sc}{\mu}
\renewcommand{\t}{\M{\xt{t}}}
\newcommand{\B}{\M{~|~}}
\newcommand{\new}{\M{\bt{new}}}
\newcommand{\NEW}[2]{\M{\new\;#1(#2)}}
\renewcommand{\bar}[1]{\M{\overline{ #1} }}
\newcommand{\m}{\M{\xt{m}}}
\newcommand{\e}{\M{\xt{e}}}
\newcommand{\n}{\M{\xt{n}}}
\renewcommand{\d}{\M{\xt{d}}}
\renewcommand{\r}{\M{\xt{r}}}
\newcommand{\f}{\M{\xt{f}}}
\newcommand{\fb}{\M{\xt{f!}}}
\newcommand{\x}{\M{\xt{x}}}
\newcommand{\C}{\M{\xt{C}}}
\newcommand{\D}{\M{\xt{D}}}
\newcommand{\err}{\M{\bt{err}}}
\renewcommand{\d}{\M{\xt{d}}}
\newcommand{\is}{\mapsto}
\newcommand{\cl}{\M{\xt{c}}}
\newcommand{\implements}{\M{\xt{implements}}}
\newcommand{\CLASS}[3]{ \M{\bt{class}\;#1\;\{ #3 \}}} 
\newcommand{\MDEF}[4] {\NT{#1(#2)}{#3} = #4}
\newcommand{\MTYPE}[3] {\NT{#1(#2)}{#3}}
\newcommand{\MVAL}[3] { #1( #2 ) = #3}
\newcommand{\Gdash}{\G\vdash}
\renewcommand{\TirNameStyle}[1]{\footnotesize\textsc{#1}}
\renewcommand{\S}{\Sigma}
\newcommand{\GSdash}{\S;\G\vdash}
\lstset{
    escapeinside={(*@}{@*)},       % if you want to add LaTeX within your code
}
\newcommand{\NT}[2]{#1\!: #2}

\newcommand{\context}{\G &::= \cdot \B \NT\x\t~\G\\}
\newcommand{\syntax}{
\begin{align*}
\t &::= ~ \any \\
   &\B \{ \bar{\NT{\m(\t)}\t}\}\\
\e &::= ~ \x \\
   &\B \e.\f \\
   &\B \e.\f=\e\\
   &\B \e.\m(\e) \\
   &\B \NEW\C{\bar{\e}}\\
   &\B \cast{\t}\e \\
   &\B \scast{\m}\e\\
\r &::= \e \B \err\\
\cl &::= \CLASS \C {\bar\D}{\bar{\NT\f\t} ~~ \bar{\MDEF\m{\NT\x\t}\t\e}} \\
\m &::= \d \B \f \B \f!\\
\context
v &::= n \B a\\
\s &::= \cdot \B  \s( a \is \{\bar{\f=v} \B \t\} )\\
F &::=    \square.\f
   \B     \square.\f = e
   \B     a.\f = \square    
   \B     \square.\m(\bar e) 
   \B     v.\m(\bar v,\square, \bar e) \\
   &\B     \ifthenelse{\square}{e}{e} 
   \B     \square + e 
   \B      v + \square\\
   &\B     \cast{\tau}\square
\B \NEW  \C {\bar{v},\square,\bar{e}}\\
\end{align*}}


\newcommand{\TVar}{\inferrule*[lab=TVar]{\G(x) = A }{\GSdash x : A}}
\newcommand{\TRef}{\inferrule*[lab=TRef]{\S(a) = \t }{\GSdash a : \t}}
\newcommand{\TInt}{\inferrule*[lab=TInt]{ }{\GSdash {n} : \int}}
\newcommand{\TSub}{\inferrule*[lab=TSub]{\GSdash e : \t' \\ \t' <: \t}{\GSdash e : \t}}

\newcommand{\TUApp}{\inferrule*[lab=TUApp]{\GSdash e_r : \any \\ \bar{\GSdash e' : \t}}{\GSdash e_r.\m(\bar{e'}) : \any}}
\newcommand{\TApp}{\inferrule*[lab=TApp]{ \GSdash e_r : \{ \ldots, \m(\bar{\t'}):\t'', \ldots \}\\ \bar{\GSdash e': \t'}}{\GSdash e_r.\m(\bar{e'}) : \t''}}
\newcommand{\TIf}{\inferrule*[lab=TIf]{ 
     \GSdash e:\int \\ 
     \GSdash e':\t \\ 
     \GSdash e'':\t
}{ 
     \GSdash \ifthenelse{e}{e'}{e''} : \t}}
\newcommand{\TPlus}{\inferrule*[lab=TPlus]{ 
  \GSdash e:\int \\ \
  \GSdash e':\int
}{ \GSdash e+e':\int}}



\newcommand{\TNew}{\inferrule*[lab=TNew]{
  \bar{\GSdash e:\t} \\ 
  \bar{\f:\t} = fields(\C)\\
}{
  \GSdash \NEW \C{\bar e}:\C
}}

\newcommand{\TCast}{\inferrule*[lab=TCast]{
  \GSdash e:\t'
}{
  \GSdash \cast{\t}e : \t}}


\newcommand{\CICast}{\inferrule*[lab=CICast]{
  \Gdash e \tlate e':\t' 
}{
  \Gdash \cast{\t} e\tlate \cast{\t}e':\t
}}

\newcommand{\CICall}{\inferrule*[lab=CICall]{
  \Gdash e \tlate e'':\{\MTYPE\m{\bar\t}{\t'},\ldots\}\\
  \bar{\CICAST{e'}{\t}{e'''}} 
}{
  \Gdash e.\m(\bar{e'}) \tlate e''.\m(\bar{e'''}):\t'
}}

\newcommand{\CICallAny}{\inferrule*[lab=CICallAny]{ 
  \Gdash e \tlate e'':\any \\  
  \bar{\Gdash e' \tlate e''':\t'} \\ 
}{
  \Gdash e.\m(\bar{e'}) \tlate (\cast{\{\m(\bar{\t'}),\ldots\}}e'').\m_u(\bar{e'''}) : \any
}}

\newcommand{\CIIf}{\inferrule*[lab=CIIf]{
  \CICAST{e_1'}{\int}{e_1''}\\ 
  \Gdash e_2\tlate e_2':\t_2 \\ 
  \Gdash e_3 \tlate e_3' : \t_2
}{
  \Gdash \ifthenelse{e_1}{e_2}{e_3} \tlate \ifthenelse{e_1'}{e_2'}{e_3'} : \t_2
} }

\newcommand{\CIPlus}{\inferrule*[lab=CIPlus]{
  \CICAST{e_1}{\int}{e_1'}\\ 
  \CICAST{e_2}{\int}{e_2'}\\ 
}{
  \Gdash e_1 + e_2 \tlate e_1' + e_2' :\int 
}}

\newcommand{\CIVar}{\inferrule*[lab=CIVar]{
  x:\t \in \G
}{
  \Gdash x \tlate x : \t
}}

\newcommand{\CINew}{\inferrule*[lab=CINew]
      {\bar{\CICAST{e}{\t}{e'}}\\
  \{\ldots \bar{\f:\t} \ldots\} = fields(\C)}
      {\Gdash \NEW \C{\bar e} \tlate \NEW\C{\bar{e'}} : \C}}


\newcommand{\EFrame}{\inferrule*[lab=EFrame]{ e,\s \ereduce e',\s'}{F[e],\s \ereduce F[e'],\s'}}

\newcommand{\ENew}{\inferrule*[lab=ENew]{
     \s'=\s(a\is\{\bar{\f:\t=v} \B \C\}) }{ \NEW \C {\bar v},\s \ereduce a,\s'}}

\newcommand{\EInv}{\inferrule*[lab=EInv]{a\is \{\m(\bar x)=e,\ldots\B \t\}}{a.\m(\bar v),\s \ereduce [a/\xt{this}][\bar{v/x}]e,\s}}

\newcommand{\EField}{\inferrule*[lab=EField]{ \s[a\is\{\f:\t=v,\ldots\B \t\}] }{a.\f,\s \ereduce v,\s}}

\newcommand{\EAssign}{\inferrule*[lab=EAssign]{ \s' = \s[a\is \{\f:\t=v,\ldots\B \t\}] }{a.\f = v,\s \ereduce v,\s'}}

\newcommand{\EIfZ}{\inferrule*[lab=EIfZ]{ }{ \ifthenelse{{0}}{e_1}{e_2},\s \ereduce e_1,\s }}

\newcommand{\EIfNZ}{\inferrule*[lab=EIfNZ]{n\neq 0}{ \ifthenelse{{n}}{e_1}{e_2},\s \ereduce e_2,\s }}

\newcommand{\EPlus}{\inferrule*[lab=EPlus]{ n_1 + n_2 = n_3 }{ {n_1} + {n_2},\s \ereduce \intv{n_3},\s}}

\newcommand{\ECastInt}{\inferrule*[lab=ECastInt]{ }{ \cast{\int}{n},\s \ereduce {n},\s'}}

\newcommand{\ECastAny}{\inferrule*[lab=ECastAny]{ }{ \cast{\any}v,\s \ereduce v,\s}}

\newcommand{\wellformedness}{
\subsection{Class well-formedness}

\begin{mathpar}
\inferrule*[lab=WFField]{\G \vdash \t}{\G\vdash\f:\t}

\inferrule*[lab=WFMeth]{\G \vdash \t \\ \bar{\G \vdash \t'} \\ \G,\this:this(\G),\bar{x:\t'} \vdash e : \t}{\G \vdash \m(\bar{x:\t'}):\t = e}

\inferrule*[lab=WFSelfGet]{\f:\t \in fields(\G)}{\G \vdash \f():\t = \xt{this}.\f}

\inferrule*[lab=WFSelfSet]{\f:\t \in fields(\G)}{\G \vdash \f!(\xt{x}:\t):\t = (\xt{this}.\f=\xt{x})}
\end{mathpar}
}
