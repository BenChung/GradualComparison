\documentclass{report}
\usepackage{fullpage,mathpartir,amsmath,amssymb,listings,amsthm,xspace}


\input{common}

\newtheorem{thm}{Theorem}
\begin{document}

\begin{mathpar}


\inferrule{
  \Ftype\f{\t} \inc \classof{\Sel\s\a}
}{ 
 \EnvType\Es\C\d{\Get\a\f}{\t}
}

\inferrule{
  \EnvType\Es\C\e{\tp1} \\
  \Ftype\f{\tp2}\inc\classof{\Sel\s\a}\\
  \tp1 \Sub \tp2
}{ 
    \EnvType\Es\C{\Set\a\f\e}{\tp1} 
}

\inferrule{
   \typeofis{\Sel\s\a}\t 
}{
   \EnvType\Es\C\a\t
}
\end{mathpar}

\section{Common case analysis}
\begin{thm} 
\label{castv}For any $v$ and $\t$ s.t. $\Gdash \t$, then there is a $v'$ such that $\cast{\t}v,\s \ereduce v',\s'$ or $\cast{\t}v,\s \ereduce \error,\s'$\end{thm}
\begin{proof}
Follows by definition of casting over all systems.
\end{proof}

\begin{thm}
\label{canonforms}If $\Sigma;\cdot \vdash v : \t$ and for some $\s$ s.t. $\Sigma \vdash \s$, then one of the following cases applies:
\begin{itemize}
\item If $\t = \int$, then $v = n$ for some $n$
\item If $\t = \C$, then $v = a$ and $\s[a \is \{\ldots | \C \}$
\item If $\t = \any$ then either $v = n$ for some $n$ or $v = a$ and $\s[a \is \{\ldots | \C \}]$
\end{itemize}
\end{thm}

\begin{thm} 
\label{cisnd}If $\Gdash e \tlate e' : \t$ or $\CICAST{e}{\t}{e'}$ then $\Gdash e' : \t$\end{thm}
\begin{proof}
Proceed on mutual rule induction over the derivation.
\begin{tabbing}
Case \=CICast:\\
\> Therefore, we know that $e' = \cast{\t}e''$, and by TCast $\Gdash \cast{\t}e'' : \t$\\
Case CICallAny:\\
\> TODO\\
Case CICall:\\
\> By the IH, $\Gdash e' : \C$ and $\bar{\Gdash e''' : \t}$\\
\> By TApp, $\Gdash e''.\m(\bar{e'''}) : \t$.\\
Case CIIf:\\
\> By the IH, $\Gdash e_1'' : \int$, $\Gdash e_2' : \t_2$, and $\Gdash e_3' : \t_2$.\\
\> Therefore, by TIf, $\Gdash \ifthenelse{e_1'}{e_2'}{e_3'} : \t_2$\\
Case CIPlus:\\
\> By the IH, $\Gdash e_1' : \int$ and $\Gdash e_2' : \int$.\\
\> Therefore, by TPlus, $\Gdash e_1' + e_2' : \int$.\\
Case CIVar:\\
\> By TVar, $\Gdash x:\t$\\
Case CINew:\\
\> By the IH, $\Gdash e' : \t$.\\
\> Then, by TNew, $\Gdash \NEW\C{\bar{e'}} : \C$ \\
Analytic cast insertion uses are covered in the proof for each system.\\
\end{tabbing}
\end{proof}


\section{Monotonic}

\begin{proof}

Extension of theorem~\ref{cisnd}.
\begin{tabbing}
Case \=CIIDown:\\
\> By CICast, $\Gdash \cast{\C}e' : \C$\\
Case CIIUp:\\
\> By the IH, $\Gdash e' : \C$\\
\> By TSub, $\Gdash e' : \xt{D}$\\
Case CIICons:\\
\> By CICast, $\Gdash \cast{\t}e' : \t$\\
Case CIID:\\
\> Trivial.\\
\end{tabbing}
\end{proof}

\begin{thm}$\GSdash \CLASS \C{\xt{D}}{\bar{\f:\t},\bar{\MDEF d{\bar{x:\t''}}{\t'}e}}$ then $\bar{\Sigma;\Gamma,\bar{x:\t''} \vdash e : \t'}$\end{thm}
\begin{proof}
Follows by class wellformedness.
\end{proof}

\begin{thm} Progress and preservation: If $\S;\cdot \vdash e : \t$ and $\S \vdash \s$ then one of the following holds
\begin{itemize}
\item $e$ value
\item $e,\s \ereduce \error,\s'$ for some $\s'$
\item $e,\s \ereduce e',\s'$ where $\S';\cdot \vdash e' : \t$ and $\S' \vdash \s'$ for some $e'$, $\s'$ and $\S'$
\end{itemize}
\end{thm}

\begin{proof}
Proceed by induction on the rule used to derive $\S;\cdot \vdash e : \t$.
\begin{tabbing}
Case \=TVar\\
\> We can exclude TVar as $\cdot$ does not contain any $x$.\\
Case TRef\\
\> $a$ is a value, therefore the theorem holds. \\
Case TInt\\
\> $n$ is a value, therefore the theorem holds. \\
Case TSub\\
\> We apply the induction hypothesis on $\GSdash e : \t'$, then the theorem holds trivially.\\
\> Note that induction is well-founded because the type is getting smaller. \\
Case TSApp\\
\> First,\= we apply the IH to the receiver $e_r$ and case analyze on the result.\\
\> \> Case \=$e_r,\s \ereduce \error,\s'$ for some $\s'$\\
\> \> \> By EFrameError (as $e = F[e_r]$), $e,\s \ereduce \error,\s'$.\\
\> \> Case $e_r,\s \ereduce e'_r,\s'$ for some $\s'$\\
\> \> \> By EFrame, $F[e_r],\s \ereduce F[e_r'],\s'$, and $e = F[e_r]$.\\
\> \> Case $e_r$ value.\\
\> We then apply the IH to each argument derivation $\Sigma;\cdot \vdash e' : \t$ and case analyze:\\
\> \> Case $e',\s \ereduce \error,\s'$ for some $\s'$\\
\> \> \> By EFrameError (as $e = F[e_r]$), $e,\s \ereduce \error,\s'$.\\
\> \> Case $e',\s \ereduce e'',\s'$ for some $\s'$\\
\> \> \> By EFrame, $F[e_r],\s \ereduce F[e''],\s'$, and $e = F[e'']$.\\
\> \> Case $e'$ value.\\
\> \> \> Continue onto next argument until all arguments are values. \\
\> Now, we know that $e_r$ value and every $e'$ value.\\
\> By canonical forms, we know that $e_r$ is either a number $n$ or a reference $a$. We then case analyze:\\
\> \> Case $e_r$ number \\
\> \> \> Therefore, we have $(\scast{\m}n).\m(\bar{e})$\\
\> \> \> By EFrame and EMethCastError, $(\scast{\m}n).\m(\bar{e}),\s \ereduce \error,\s$\\
\> \> Case $e_r$ reference \\
\> \> \> If \=$e_r$ reference, by canonical forms $\s[e_r \is \{\ldots \B \C \}]$.\\
\> \> \> Define $\bar{\t'}$ such that $\bar{\S,\cdot \vdash e' : \t'}$\\
\> \> \> Case analyze on $\m(\bar{x}) \in meths(\C)$\\
\> \> \> \> Case \=$\m(\bar{x}) \not\in meths(\C)$ \\
\> \> \> \> \>  By EFrame and EMethCastError, $(\scast{\m}a).\m(\bar{e}),\s \ereduce \error,\s$\\
\> \> \> \> Case $\m(\bar{x}) \in meths(\C)$ \\
\> \> \> \> \> Therefore, $\m(\bar{x}) = e_m \in \C$ for some $e_m$\\
\> \> \> \> \> Apply EInv to find that $e_r.\m(\bar{e'}),\s \ereduce [e_r/\xt{this}][\bar{e'/x}]e_m,\s$ \\
Case TApp\\
\> We apply the IH to the receiver typing judgment $\S';\cdot \vdash e_r : \C$ and case analyze:\\
\> \> Case \=$e_r,\s \ereduce \error,\s'$ for some $\s'$\\
\> \> \> By EFrameError (as $e = F[e_r]$), $e,\s \ereduce \error,\s'$.\\
\> \> Case $e_r,\s \ereduce e_r',\s'$ for some $\s'$\\
\> \> \> By EFrame, $F[e_r],\s \ereduce F[e_r'],\s'$, and $e = F[e_r]$.\\
\> \> Case $e_r$ value.\\
\> We then apply the IH to each argument derivation $\Sigma;\cdot \vdash e' : \t'$ and case analyze:\\
\> \> Case $e',\s \ereduce \error,\s'$ for some $\s'$\\
\> \> \> By EFrameError (as $e = F[e_r]$), $e,\s \ereduce \error,\s'$.\\
\> \> Case $e',\s \ereduce e'',\s'$ for some $\s'$\\
\> \> \> By EFrame, $F[e_r],\s \ereduce F[e''],\s'$, and $e = F[e'']$.\\
\> \> Case $e'$ value.\\
\> \> \> Continue onto next argument until all arguments are values. \\
\> Now, we know that $e_r$ value and every $e'$ value.\\
\> By canonical forms, we know that $\s[e_r \is \{ \ldots \B \C\}]$\\
\> By inversion, we know that $\m(\bar{x}) = e \in \C$\\
\> Therefore, we apply EInv to find that $e_r.\m(\bar{e'}),\s \ereduce [e_r/\xt{this}][\bar{e'/x}]e_m,\s$ \\
Case TIf\\
Case TPlus\\
Case TNew\\
Case TCast\\
\end{tabbing}
\end{proof}
\section{Typed Racket}
\section{Strongscript}
\end{document}