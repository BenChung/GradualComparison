\documentclass{report}
\usepackage{fullpage,mathpartir,amsmath,amssymb,listings,amsthm,xspace}
%%% Metavariables %%%%%%%%%%%%%%%%%%%
\newcommand{\fd}{\M{\xt{fd}}}
\newcommand{\md}{\M{\xt{md}}}
\newcommand{\mt}{\M{\xt{mt}}}
\newcommand{\m}{\M{\xt{m}}}
\newcommand{\e}{\M{\xt{e}}}
\newcommand{\n}{\M{\xt{n}}}
\renewcommand{\d}{\M{\xt{d}}}
\renewcommand{\r}{\M{\xt{r}}}
\newcommand{\f}{\M{\xt{f}}}
\newcommand{\fb}{\M{\xt{f!}}}
\newcommand{\x}{\M{\xt{x}}}
\renewcommand{\t}{\M{\xt{t}}}
\renewcommand{\c}{\M{\xt{c}}}
\newcommand{\C}{\M{\xt{C}}}
\newcommand{\D}{\M{\xt{D}}}
\newcommand{\this}{\M{\xt{this}}}
\newcommand{\err}{\M{\bt{err}}}
\renewcommand{\d}{\M{\xt{d}}}
\newcommand{\s}{\M{\sigma}}
\newcommand{\fv}{\M{\xt{fv}}}
\renewcommand{\a}{\M{\xt a}}
\newcommand{\F}{\M{\xt F}}
\newcommand{\T}{\M{\xt T}}
\newcommand{\tp}[1]{\M{ \t_{#1} }}
\newcommand{\ep}[1]{\M{ \e_{#1} }}
\newcommand{\ap}[1]{\M{ \a_{#1} }}
\renewcommand{\mp}[1]{\M{ \m_{#1} }}
\renewcommand{\sp}[1]{\M{ \s_{#1} }}
\newcommand{\none}{\M{\cdot}}
%% Keywords %%%%%%%%%%%%%%%%%%
\newcommand{\new}{\M{\bt{new}}}
\newcommand{\class}{\M{\bt{class}}}
%% Expressions %%%%%%%%%%%%%%%%%%%%
\newcommand{\Get}[2]{\M{#1.#2}}
\newcommand{\Set}[3]{\M{#1.#2:=#3}}
\newcommand{\Call}[3]{\M{#1.#2(#3)}}
\newcommand{\New}[2]{\M{\new\;#1({#2})}}
\newcommand{\Cast}[2]{\M{\langle{#1}\rangle{#2}}}
%% Types %%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\any}{\M{\star}}
\newcommand{\Type}[1]{\M{\{ #1 \}}}
\newcommand{\HT}[2]{\M{{#1}\!:{#2}}}
%% Classes %%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\Mdef}[5]{\M{ \HT { #1( \b{\HT{#2}{#3}})}{#4}={#5}}}
\newcommand{\SMdef}[5]{\M{ \HT { #1!( \HT{#2}{#3})}{#4}= {#5}}}
\newcommand{\GMdef}[3]{\M{ \HT { #1()}{#2}={#3}}}
\newcommand{\Ftype}[2]{\M{ \HT{#1}{#2} }}
\newcommand{\Fdef}[3]{\M{ \HT{#1}{#2}={#3} }}
\newcommand{\Mtype}[3]{\M{ \HT { #1( #2 )}{#3}}}
\newcommand{\Class}[3]{\M{\bt{class}\;#1\{ #2 ~ #3 \}}}
%%% Dynamics %%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\is}{\M{\mapsto}}
\newcommand{\Obj}[3]{ \M{\{ #1 \}^{#2}_{#3}}}
\newcommand{\Heap}[2]{\M{ #1[ #2 ] }}
%% Formatting %%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\Alt}[1]{ &\B #1 \\}
\newcommand{\B}{\M{~|~}}
\newcommand{\M}[1]{\ensuremath{#1}\xspace}
\newcommand{\xt}[1]{{\sf{#1}}\xspace}
\newcommand{\bt}[1]{\xt{\bf #1}}
\renewcommand{\b}[1]{\M{\overline{#1}}}
\newcommand{\opdef}[2]{\framebox[1.1\width]{#1} ~ #2\\}

\newcommand{\IRule}[3]{\inferrule*[lab={\tiny #1}]{#2}{#3}}
%\newcommand{\IRule}[3]{\inferrule{#2}{#3}}    %% No label
\newcommand{\CondRule}[3]{ #3 & {if} #2 \\}
\newcommand{\NoCondRule}[2]{ #2 &       \\}
\newcommand{\Reduce}[4]{\M{ #1~#2 \rightarrow #3~#4}}
\newcommand{\ReduceA}[4]{\M{ #1 ~ #2 } &  \M { \rightarrow #3 ~ #4}}
\newcommand{\inc}{\M{\in}}
\newcommand{\Update}[3]{\M{#1[ #2 := #3]}}
\newcommand{\Bind}[2]{\M{#1 \is #2}}
\newcommand{\NotSub}{\M{\not<:}}
\newcommand{\Sub}{\M{<:}}
\newcommand{\classofis}[2]{\M{\xt{classof}(#1)=#2}}
\newcommand{\typeofis}[2]{\M{\xt{typeof}(#1)=#2}}
\newcommand{\classof}[1]{\M{\xt{classof}(#1)}}
\newcommand{\typeof}[1]{\M{\xt{typeof}(#1)}}
\newcommand{\Sel}[2]{\M{#1(#2)}}

\newcommand{\EnvType}[3]{ \M{#1 \vdash #2 : #3}}
\newcommand{\HasType}[3]{ \M{#1 (#2) = #3}}
\newcommand{\E}{\M{\Gamma}}
\newcommand{\Es}{\E ~\s}

\newcommand{\TransClass}[2]{\M{ #1 \hookrightarrow #2 }}
\newcommand{\TransExp}[4]{\M{ #1 \vdash #2 \hookrightarrow #3 : #4 }}
\newcommand{\mdp}[1]{\M{\md_{#1}}}
\newcommand{\setter}[1]{\M{\llbracket #1  \rrbracket}_{\xt{set}}}
\newcommand{\getter}[1]{\M{\llbracket #1  \rrbracket_{\xt{get}}}}
\newcommand{\dynamic}[1]{\M{\llbracket #1  \rrbracket_{\xt{dyn}}}}
\newcommand{\invoke}[1]{\M{\llbracket #1 \rrbracket_{\xt{inv}}}}
\newcommand{\Dyn}[1]{\M{#1^{\any} }}

\newtheorem{thm}{Theorem}
\begin{document}

\begin{figure}
\begin{mathpar}
\IRule{RW1}{
    \HasType\E\x\t
 }{
   \EnvType\s\x\t
}

\IRule{RW2}{
   \EnvType\Es\e{\tp 1} \\ \tp 1 \Sub \t
 }{
   \EnvType\Es\e\t 
}   

\IRule{RW3}{
   \EnvType\Es\e\any \\ \b{\EnvType\E{\ep1}\t }
}{
   \EnvType\Es{\Call\e{\Dyn\m}{\b{\ep1}}}\any
}

\IRule{RW4}{
   \EnvType\Es\e{\tp1} \\ \Mtype\m{\b{\tp2}}\t\inc \tp1  \\  \b{\EnvType\E{\ep1}{\tp 2}}
}{
    \EnvType\Es{\Call\e\m{\b{\ep1}}}\t
}    

\IRule{RW5}{
  \b{\EnvType\Es\e\t} \\ 
  \Class \C {\b{\Ftype\f\t}} {\b{\md}}
}{
  \EnvType\Es{\New\C{\b\e}}\C
}

\IRule{RW6}{
  \EnvType\Es\e{\tp1}
}{
   \EnvType\Es{\Cast\t\e}\t
}

\IRule{RW7}{
  \Ftype\f{\t} \inc \classof{\Sel\s\a}
}{ 
 \EnvType\Es{\Get\a\f}{\t}
}

\IRule{RW8}{
  \EnvType\Es\e{\tp1} \\
  \Ftype{\f}{\tp2}\inc\classof{\Sel\s\a}\\
  \tp1 \Sub \tp2
}{ 
    \EnvType\Es{\Set\a\f\e}{\tp1} 
}

\IRule{RW9}{
   \typeofis{\Sel\s\a}\t 
}{
   \EnvType\Es\a\t
}
\end{mathpar}
\caption{Runtime typing rules}
\end{figure}


\section{Common core}

Theorem 1: Type translation. If $\EnvType\E\e\t$ then $\TransExp\E\e{\e'}\t$ and $\EnvType{\E ~ \cdot}{\e'}\t$.

Proof: By rule induction on $\EnvType\E\e\t$. For other rules than W3, the theorem holds trivially, for W3 we present the proof

\begin{tabbing}
Case \=W3 \\
\> By IH, $\TransExp\E\e{\ep2}\any$ and $\EnvType\Es{\ep2}\any$.\\
\> By IH, for every $\ep1$, $\TransExp\E{\ep1}{\ep3}\t$ and $\EnvType\Es{\ep3}\t$.\\
\> As $\TransExp\E\e{\ep2}\any$, $\TransExp\E{\Call\e\m{\b{\ep 1}}} {\Call{\ep 2}{\Dyn{\m}}{\b{\ep 3}}} \any$\\
\> Therefore, we apply RW3 and $\EnvType\Es{\Call{\ep 2}{\Dyn{\m}}{\b{\ep 3}}} \any$ and the theorem holds.\\
\end{tabbing}

Lemma 1: Substitution. If $\EnvType{\E,\b{\x:\t} ~ \s}{\e}{\t}$ and $\b{\EnvType{~\s}{\a}{\t}}$ then $\EnvType{\Es}{\e[\b{\x/\a}]}{\t}$

TODO.

Theorem 2: Progress and preservation. If $\EnvType{~\s}{\e}{\t}$ then $\s,\e \rightarrow \s',\e'$ for $\e'$ expression and $\EnvType{~\s}{\e'}{\t}$ or $\e' ~ \err$.

Proof by rule induction on $\EnvType{\cdot~\s}{\e}{\t}$.
\begin{tabbing}
Case \=RW1 \\
\> Ruled out, as $\E$ is empty.\\
Case \=RW2 \\
\> Follows by IH on inversion. \\
Case \=RW3 \\
\> By the IH on $\EnvType\Es\e\any$, either $\e$ some expression or $\e$ err. \\
\> If $\e$ expression but not value, then the theorem holds through the frame evaluation rule. \\
\> If $\e~\err$, then by frame error evaluation we produce $\err$ and the theorem holds. \\
\> If $\e$ value, then repeat for each of the arguments in left to right, following by the frame evaluation rule. \\
\> Let $a$ be $\e$ and $a_1,\ldots,a_i$ be the results of stepping each of the $e_1$s.\\
\> Case \=analyze \=on if $a$ has $\Dyn\m$\\
\> \> $\Dyn\m \not\in \classof{\s(a)}$\\
\> \> \> By the 4th evaluation rule, $\s,e \rightarrow \s,\err$.\\
\> \> $\Dyn\m \in \classof{\s(a)}$\\
\> \> \> Because $\Dyn\m$ is a generated method, we know that it is of the form $\Mdef{\Dyn\m}\x\any{\any}\e_m$.\\
\> \> \> We also know that $\EnvType{\b{\x:\any}~\s}{\e_m}\any$\\
\> \> \> By weakening we know that $\EnvType{\this:\C,\b{\x:\any}~\s}{\e_m}\any$\\
\> \> \> By substitution, $\EnvType{\cdot~\s}{\e_m[\this/v,\b{x/a_i}]}{\any}$\\
\> \> \> Therefore, the theorem holds. \\
Case \=RW4 \\
\> By the IH on $\EnvType\Es\e\any$, either $\e$ some expression or $\e$ err. \\
\> If $\e$ expression but not value, then the theorem holds through the frame evaluation rule. \\
\> If $\e~\err$, then by frame error evaluation we produce $\err$ and the theorem holds. \\
\> If $\e$ value, then repeat for each of the arguments in left to right, following by the frame evaluation rule. \\
\> Let $a$ be $\e$ and $\b{a_1}$ be the results of stepping each of the $\b{e_1}$s.\\
\> We know by inversion that $\Mtype\m{\tp2}{\t}\in\tp1$ so by canonical forms $\Mdef\m\x{\tp2}\t\e \in \s(a)$. \\
\> By class wellformedness, we have that $\EnvType{\b{x:\tp2}~\s}\e\t$.\\
\> Since we know that $\EnvType{\cdot~\s}{a_1}{\tp2}$ by inversion, we know that $\EnvType{\cdot~\s}{\e[\b{x/a_1}]}\t$ by substitution.\\
\> Therefore, the theorem holds. \\
Case \=RW5 \\
\> Apply the IH to each of the argument $\b{\e_1}$ left-to-right. If any are unevaluated, continue by frames.\\
\> If any produce err, then step out to err based on the frame err rule.\\
\> Therefore, all arguments $\b{e_1}$ are evaluated to the values $\b{a_1}$.\\
\> By inversion we know that $\b{\EnvType{\cdot~\s}{a_1}{\t}}$.\\
\> Then consider some $\ap2$ and an extended heap $\sp 2 = \Heap{\s}{ \Bind{\ap 2}{\Obj{\b{\Fdef\f\t\a_1}}\C\C\}}}$.\\
\> By RW9 $\EnvType{\cdot~\sp2}{\ap2}{\C}$ so the theorem holds.\\
Case \=RW6 \\
\> Apply IH to inversion, if $\e~\err$ then we err by frame evaluation, or if $e$ steps then we step.\\
\> If $\e$ value then let it be denoted $\a$.\\
\> If $\t$ is $\any$, then we step to $\e$ and the theorem holds trivially.\\
\> Otherwise, if $\typeof{\s(a)} \Sub \t$, then we step to $\a$ and the theorem holds (by RW9 and RW2).\\
\> If $\typeof{\s(a)}\not\Sub\t$, then we step to $\err$ and the theorem holds.\\
Case \=RW7 \\
Case \=RW8 \\
Case \=RW9 \\
\end{tabbing}

For a list of classes $\bar{\c}$ such that $\b{\c ~~ WF}$ and an expression $e$ such that $\EnvType\cdot\e\t$ and $\b{\TransClass\c{\c'}}$, we have $\cdot~e \rightarrow^* \sigma~r$ (against $\b{\c'}$) where $r$ is either a value or $\err$.


\section{Monotonic}
\section{Typed Racket}
\section{Strongscript}
\end{document}